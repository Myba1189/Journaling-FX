<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
	<title></title>
	<meta name="generator" content="LibreOffice 24.8.1.2 (Linux)"/>
	<meta name="created" content="00:00:00"/>
	<meta name="changed" content="00:00:00"/>
	<style type="text/css">
		@page { size: 8.27in 11.69in; margin: 0.79in }
		p { line-height: 115%; margin-bottom: 0.1in; background: transparent }
		pre { background: transparent }
		pre.western { font-family: "Liberation Mono", monospace; font-size: 10pt }
		pre.cjk { font-family: "NSimSun", monospace; font-size: 10pt }
		pre.ctl { font-family: "Liberation Mono", monospace; font-size: 10pt }
	</style>
</head>
<body lang="en-US" link="#000080" vlink="#800000" dir="ltr"><pre class="western">&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;es&quot;&gt;
&lt;head&gt;
    &lt;meta charset=&quot;UTF-8&quot;&gt;
    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;&gt;
    &lt;title&gt;Diario de Trading Interactivo&lt;/title&gt;
    &lt;script src=&quot;https://cdn.tailwindcss.com&quot;&gt;&lt;/script&gt;
    &lt;script src=&quot;https://cdn.jsdelivr.net/npm/chart.js&quot;&gt;&lt;/script&gt;
    &lt;link rel=&quot;preconnect&quot; href=&quot;https://fonts.googleapis.com&quot;&gt;
    &lt;link rel=&quot;preconnect&quot; href=&quot;https://fonts.gstatic.com&quot; crossorigin&gt;
    &lt;link href=&quot;https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap&quot; rel=&quot;stylesheet&quot;&gt;
    &lt;!-- Chosen Palette: Calm Focus --&gt;
    &lt;!-- Application Structure Plan: The SPA is designed with a task-oriented navigation. The key addition is the Funding Challenge Simulator logic. The 'Plan de Trading' view now includes a setting for the initial balance. The 'Dashboard' has a new, prominent &quot;Challenge Status&quot; section that provides at-a-glance information on the user's standing against the 5% daily and 10% overall loss rules. This structure transforms the journal from a passive tracker into an active training tool. --&gt;
    &lt;!-- Visualization &amp; Content Choices: The new &quot;Challenge Status&quot; section uses clear stat cards and a color-coded status badge (green/red) to instantly communicate the user's situation. The logic for disabling the &quot;Add Trade&quot; button upon failure reinforces the simulation. Existing charts and KPIs remain to provide detailed performance analysis. This combination provides both high-level challenge status and deep analytical capabilities. --&gt;
    &lt;!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. --&gt;
    &lt;style&gt;
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* slate-50 */
        }
        .chart-container {
            position: relative;
            width: 100%;
            height: 320px;
            max-height: 400px;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 400px;
            }
        }
        .nav-link {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out;
            cursor: pointer;
            font-weight: 500;
        }
        .nav-link.active {
            background-color: #e0f2fe; /* sky-100 */
            color: #0c4a6e; /* sky-900 */
            font-weight: 600;
        }
        .nav-link:not(.active):hover {
            background-color: #f1f5f9; /* slate-100 */
        }
        .modal {
            display: none;
        }
        .modal.open {
            display: flex;
        }
        .calendar-day {
            min-height: 120px;
        }
    &lt;/style&gt;
&lt;/head&gt;
&lt;body class=&quot;text-slate-800&quot;&gt;

    &lt;div class=&quot;flex h-screen bg-slate-50&quot;&gt;
        &lt;!-- Sidebar Navigation --&gt;
        &lt;aside class=&quot;w-64 bg-white border-r border-slate-200 flex-shrink-0 flex flex-col&quot;&gt;
            &lt;div&gt;
                &lt;div class=&quot;p-4&quot;&gt;
                    &lt;h1 class=&quot;text-2xl font-bold text-slate-900&quot;&gt;Fortaleza&lt;/h1&gt;
                    &lt;p class=&quot;text-sm text-slate-500&quot;&gt;Simulador de Fondeo&lt;/p&gt;
                &lt;/div&gt;
                &lt;nav class=&quot;p-2&quot;&gt;
                    &lt;a id=&quot;nav-dashboard&quot; class=&quot;nav-link active&quot;&gt;&lt;svg xmlns=&quot;http://www.w3.org/2000/svg&quot; class=&quot;h-5 w-5 mr-3&quot; viewBox=&quot;0 0 20 20&quot; fill=&quot;currentColor&quot;&gt;&lt;path d=&quot;M2 10a8 8 0 018-8v8h8a8 8 0 11-16 0z&quot; /&gt;&lt;path d=&quot;M12 2.252A8.014 8.014 0 0117.748 8H12V2.252z&quot; /&gt;&lt;/svg&gt;Dashboard&lt;/a&gt;
                    &lt;a id=&quot;nav-analysis&quot; class=&quot;nav-link&quot;&gt;&lt;svg xmlns=&quot;http://www.w3.org/2000/svg&quot; class=&quot;h-5 w-5 mr-3&quot; viewBox=&quot;0 0 20 20&quot; fill=&quot;currentColor&quot;&gt;&lt;path d=&quot;M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z&quot; /&gt;&lt;/svg&gt;Análisis&lt;/a&gt;
                    &lt;a id=&quot;nav-calendar&quot; class=&quot;nav-link&quot;&gt;&lt;svg xmlns=&quot;http://www.w3.org/2000/svg&quot; class=&quot;h-5 w-5 mr-3&quot; viewBox=&quot;0 0 20 20&quot; fill=&quot;currentColor&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z&quot; clip-rule=&quot;evenodd&quot; /&gt;&lt;/svg&gt;Calendario&lt;/a&gt;
                    &lt;a id=&quot;nav-plan&quot; class=&quot;nav-link&quot;&gt;&lt;svg xmlns=&quot;http://www.w3.org/2000/svg&quot; class=&quot;h-5 w-5 mr-3&quot; viewBox=&quot;0 0 20 20&quot; fill=&quot;currentColor&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z&quot; clip-rule=&quot;evenodd&quot; /&gt;&lt;/svg&gt;Plan de Trading&lt;/a&gt;
                    &lt;a id=&quot;nav-review&quot; class=&quot;nav-link&quot;&gt;&lt;svg xmlns=&quot;http://www.w3.org/2000/svg&quot; class=&quot;h-5 w-5 mr-3&quot; viewBox=&quot;0 0 20 20&quot; fill=&quot;currentColor&quot;&gt;&lt;path d=&quot;M9 2a1 1 0 000 2h2a1 1 0 100-2H9z&quot; /&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z&quot; clip-rule=&quot;evenodd&quot; /&gt;&lt;/svg&gt;Revisión Semanal&lt;/a&gt;
                &lt;/nav&gt;
            &lt;/div&gt;
            &lt;div class=&quot;p-4 mt-auto&quot;&gt;
                &lt;button id=&quot;add-trade-btn&quot; class=&quot;w-full bg-sky-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-sky-700 transition-colors disabled:bg-slate-400 disabled:cursor-not-allowed&quot;&gt;+ Añadir Operación&lt;/button&gt;
            &lt;/div&gt;
        &lt;/aside&gt;

        &lt;!-- Main Content --&gt;
        &lt;main class=&quot;flex-1 overflow-y-auto p-4 md:p-8&quot;&gt;
            
            &lt;!-- Dashboard View --&gt;
            &lt;div id=&quot;view-dashboard&quot;&gt;
                &lt;header class=&quot;mb-8&quot;&gt;
                    &lt;h2 class=&quot;text-3xl font-bold text-slate-900&quot;&gt;Dashboard de Guerra&lt;/h2&gt;
                    &lt;p class=&quot;text-slate-500 mt-1&quot;&gt;Tus métricas de rendimiento en tiempo real. Analiza, aprende y conquista.&lt;/p&gt;
                &lt;/header&gt;

                &lt;!-- Challenge Status --&gt;
                &lt;section class=&quot;bg-white p-6 rounded-xl border border-slate-200 mb-8&quot;&gt;
                    &lt;div class=&quot;flex justify-between items-center&quot;&gt;
                        &lt;h3 class=&quot;font-bold text-lg text-slate-900&quot;&gt;Estado del Desafío de Fondeo&lt;/h3&gt;
                        &lt;div id=&quot;challenge-status-badge&quot; class=&quot;px-3 py-1 text-sm font-bold rounded-full&quot;&gt;&lt;/div&gt;
                    &lt;/div&gt;
                    &lt;div class=&quot;grid grid-cols-2 md:grid-cols-4 gap-6 mt-4 text-center&quot;&gt;
                        &lt;div&gt;&lt;p class=&quot;text-sm text-slate-500&quot;&gt;Balance Inicial&lt;/p&gt;&lt;p id=&quot;status-initial-balance&quot; class=&quot;font-bold text-lg text-slate-800&quot;&gt;$0.00&lt;/p&gt;&lt;/div&gt;
                        &lt;div&gt;&lt;p class=&quot;text-sm text-slate-500&quot;&gt;Pérdida Diaria Máx. (5%)&lt;/p&gt;&lt;p id=&quot;status-daily-loss-limit&quot; class=&quot;font-bold text-lg text-red-600&quot;&gt;$0.00&lt;/p&gt;&lt;/div&gt;
                        &lt;div&gt;&lt;p class=&quot;text-sm text-slate-500&quot;&gt;Pérdida Total Máx. (10%)&lt;/p&gt;&lt;p id=&quot;status-max-loss-limit&quot; class=&quot;font-bold text-lg text-red-600&quot;&gt;$0.00&lt;/p&gt;&lt;/div&gt;
                        &lt;div&gt;&lt;p class=&quot;text-sm text-slate-500&quot;&gt;Drawdown Actual&lt;/p&gt;&lt;p id=&quot;status-current-drawdown&quot; class=&quot;font-bold text-lg text-slate-800&quot;&gt;$0.00&lt;/p&gt;&lt;/div&gt;
                    &lt;/div&gt;
                &lt;/section&gt;

                &lt;section class=&quot;grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8&quot;&gt;
                    &lt;div class=&quot;bg-white p-6 rounded-xl border border-slate-200&quot;&gt;&lt;h3 class=&quot;text-slate-500 font-medium&quot;&gt;Profit Factor&lt;/h3&gt;&lt;p id=&quot;kpi-profit-factor&quot; class=&quot;text-3xl font-bold text-slate-900 mt-2&quot;&gt;0.00&lt;/p&gt;&lt;/div&gt;
                    &lt;div class=&quot;bg-white p-6 rounded-xl border border-slate-200&quot;&gt;&lt;h3 class=&quot;text-slate-500 font-medium&quot;&gt;Win Rate&lt;/h3&gt;&lt;p id=&quot;kpi-win-rate&quot; class=&quot;text-3xl font-bold text-slate-900 mt-2&quot;&gt;0%&lt;/p&gt;&lt;/div&gt;
                    &lt;div class=&quot;bg-white p-6 rounded-xl border border-slate-200&quot;&gt;&lt;h3 class=&quot;text-slate-500 font-medium&quot;&gt;R:R Promedio Obtenido&lt;/h3&gt;&lt;p id=&quot;kpi-avg-rr&quot; class=&quot;text-3xl font-bold text-slate-900 mt-2&quot;&gt;0.00R&lt;/p&gt;&lt;/div&gt;
                    &lt;div class=&quot;bg-white p-6 rounded-xl border border-slate-200&quot;&gt;&lt;h3 class=&quot;text-slate-500 font-medium&quot;&gt;Expectativa&lt;/h3&gt;&lt;p id=&quot;kpi-expectancy&quot; class=&quot;text-3xl font-bold text-slate-900 mt-2&quot;&gt;$0.00&lt;/p&gt;&lt;/div&gt;
                &lt;/section&gt;
                &lt;section class=&quot;grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8&quot;&gt;
                    &lt;div class=&quot;bg-white p-6 rounded-xl border border-slate-200&quot;&gt;&lt;h3 class=&quot;font-bold text-lg text-slate-900&quot;&gt;Curva de Capital&lt;/h3&gt;&lt;div class=&quot;chart-container mt-4&quot;&gt;&lt;canvas id=&quot;equity-curve-chart&quot;&gt;&lt;/canvas&gt;&lt;/div&gt;&lt;/div&gt;
                    &lt;div class=&quot;bg-white p-6 rounded-xl border border-slate-200&quot;&gt;&lt;h3 class=&quot;font-bold text-lg text-slate-900&quot;&gt;Disciplina vs. Rentabilidad&lt;/h3&gt;&lt;div class=&quot;chart-container mt-4&quot;&gt;&lt;canvas id=&quot;discipline-chart&quot;&gt;&lt;/canvas&gt;&lt;/div&gt;&lt;/div&gt;
                &lt;/section&gt;
                &lt;section class=&quot;bg-white p-6 rounded-xl border border-slate-200&quot;&gt;
                    &lt;h3 class=&quot;font-bold text-lg text-slate-900 mb-4&quot;&gt;Registro de Batalla&lt;/h3&gt;
                    &lt;div class=&quot;overflow-x-auto&quot;&gt;&lt;table class=&quot;w-full text-sm text-left text-slate-500&quot;&gt;&lt;thead class=&quot;text-xs text-slate-700 uppercase bg-slate-100&quot;&gt;&lt;tr&gt;&lt;th scope=&quot;col&quot; class=&quot;px-6 py-3&quot;&gt;Fecha&lt;/th&gt;&lt;th scope=&quot;col&quot; class=&quot;px-6 py-3&quot;&gt;Par&lt;/th&gt;&lt;th scope=&quot;col&quot; class=&quot;px-6 py-3&quot;&gt;R:R Esp.&lt;/th&gt;&lt;th scope=&quot;col&quot; class=&quot;px-6 py-3&quot;&gt;R:R Obt.&lt;/th&gt;&lt;th scope=&quot;col&quot; class=&quot;px-6 py-3&quot;&gt;Resultado ($)&lt;/th&gt;&lt;th scope=&quot;col&quot; class=&quot;px-6 py-3&quot;&gt;Disciplina&lt;/th&gt;&lt;th scope=&quot;col&quot; class=&quot;px-6 py-3&quot;&gt;Captura&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody id=&quot;trade-log-body&quot;&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/div&gt;
                &lt;/section&gt;
            &lt;/div&gt;

            &lt;!-- Analysis View --&gt;
            &lt;div id=&quot;view-analysis&quot; class=&quot;hidden&quot;&gt;
                &lt;header class=&quot;mb-8&quot;&gt;
                    &lt;h2 class=&quot;text-3xl font-bold text-slate-900&quot;&gt;Análisis de Rendimiento&lt;/h2&gt;
                    &lt;p class=&quot;text-slate-500 mt-1&quot;&gt;Desglosa tus resultados para encontrar tus fortalezas y debilidades.&lt;/p&gt;
                &lt;/header&gt;
                &lt;section class=&quot;grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8&quot;&gt;
                    &lt;div class=&quot;bg-white p-6 rounded-xl border border-slate-200&quot;&gt;
                        &lt;h3 class=&quot;font-bold text-lg text-slate-900 mb-4&quot;&gt;Rendimiento por Dirección&lt;/h3&gt;
                        &lt;div class=&quot;grid grid-cols-2 gap-4 text-center&quot;&gt;
                            &lt;div&gt;
                                &lt;p class=&quot;text-sm text-slate-500&quot;&gt;Win Rate (Compras)&lt;/p&gt;
                                &lt;p id=&quot;analysis-buy-wr&quot; class=&quot;text-2xl font-bold text-green-600 mt-1&quot;&gt;0%&lt;/p&gt;
                            &lt;/div&gt;
                             &lt;div&gt;
                                &lt;p class=&quot;text-sm text-slate-500&quot;&gt;Win Rate (Ventas)&lt;/p&gt;
                                &lt;p id=&quot;analysis-sell-wr&quot; class=&quot;text-2xl font-bold text-red-600 mt-1&quot;&gt;0%&lt;/p&gt;
                            &lt;/div&gt;
                        &lt;/div&gt;
                        &lt;div class=&quot;chart-container mt-4&quot;&gt;&lt;canvas id=&quot;analysis-buysell-chart&quot;&gt;&lt;/canvas&gt;&lt;/div&gt;
                    &lt;/div&gt;
                    &lt;div class=&quot;bg-white p-6 rounded-xl border border-slate-200&quot;&gt;
                        &lt;h3 class=&quot;font-bold text-lg text-slate-900 mb-4&quot;&gt;Rendimiento por Sesión (GMT-3)&lt;/h3&gt;
                        &lt;div class=&quot;chart-container mt-4&quot;&gt;&lt;canvas id=&quot;analysis-session-chart&quot;&gt;&lt;/canvas&gt;&lt;/div&gt;
                    &lt;/div&gt;
                &lt;/section&gt;
                &lt;section class=&quot;bg-white p-6 rounded-xl border border-slate-200&quot;&gt;
                    &lt;h3 class=&quot;font-bold text-lg text-slate-900 mb-4&quot;&gt;Rendimiento por Instrumento&lt;/h3&gt;
                    &lt;div class=&quot;chart-container mt-4&quot;&gt;&lt;canvas id=&quot;analysis-pair-chart&quot;&gt;&lt;/canvas&gt;&lt;/div&gt;
                &lt;/section&gt;
            &lt;/div&gt;

            &lt;!-- Calendar View --&gt;
            &lt;div id=&quot;view-calendar&quot; class=&quot;hidden&quot;&gt;
                 &lt;header class=&quot;mb-8&quot;&gt;&lt;h2 class=&quot;text-3xl font-bold text-slate-900&quot;&gt;Calendario de Batalla&lt;/h2&gt;&lt;p class=&quot;text-slate-500 mt-1&quot;&gt;Tu rendimiento diario de un solo vistazo. Verde es victoria, rojo es lección.&lt;/p&gt;&lt;/header&gt;
                &lt;div class=&quot;bg-white p-6 rounded-xl border border-slate-200&quot;&gt;&lt;div class=&quot;flex items-center justify-between mb-4&quot;&gt;&lt;button id=&quot;prev-month-btn&quot; class=&quot;p-2 rounded-full hover:bg-slate-100&quot;&gt;&lt;svg xmlns=&quot;http://www.w3.org/2000/svg&quot; class=&quot;h-6 w-6 text-slate-500&quot; fill=&quot;none&quot; viewBox=&quot;0 0 24 24&quot; stroke=&quot;currentColor&quot;&gt;&lt;path stroke-linecap=&quot;round&quot; stroke-linejoin=&quot;round&quot; stroke-width=&quot;2&quot; d=&quot;M15 19l-7-7 7-7&quot; /&gt;&lt;/svg&gt;&lt;/button&gt;&lt;h3 id=&quot;calendar-month-year&quot; class=&quot;text-xl font-bold text-slate-800&quot;&gt;&lt;/h3&gt;&lt;button id=&quot;next-month-btn&quot; class=&quot;p-2 rounded-full hover:bg-slate-100&quot;&gt;&lt;svg xmlns=&quot;http://www.w3.org/2000/svg&quot; class=&quot;h-6 w-6 text-slate-500&quot; fill=&quot;none&quot; viewBox=&quot;0 0 24 24&quot; stroke=&quot;currentColor&quot;&gt;&lt;path stroke-linecap=&quot;round&quot; stroke-linejoin=&quot;round&quot; stroke-width=&quot;2&quot; d=&quot;M9 5l7 7-7 7&quot; /&gt;&lt;/svg&gt;&lt;/button&gt;&lt;/div&gt;&lt;div class=&quot;grid grid-cols-7 gap-px text-center text-sm font-semibold text-slate-500 border-b border-slate-200 mb-1&quot;&gt;&lt;div&gt;Lun&lt;/div&gt;&lt;div&gt;Mar&lt;/div&gt;&lt;div&gt;Mié&lt;/div&gt;&lt;div&gt;Jue&lt;/div&gt;&lt;div&gt;Vie&lt;/div&gt;&lt;div&gt;Sáb&lt;/div&gt;&lt;div&gt;Dom&lt;/div&gt;&lt;/div&gt;&lt;div id=&quot;calendar-grid&quot; class=&quot;grid grid-cols-7 gap-px&quot;&gt;&lt;/div&gt;&lt;/div&gt;
            &lt;/div&gt;

            &lt;!-- Plan de Trading View --&gt;
            &lt;div id=&quot;view-plan&quot; class=&quot;hidden&quot;&gt;
                 &lt;header class=&quot;mb-8&quot;&gt;&lt;h2 class=&quot;text-3xl font-bold text-slate-900&quot;&gt;Plan de Trading y Desafío&lt;/h2&gt;&lt;p class=&quot;text-slate-500 mt-1&quot;&gt;Tus leyes y la configuración de tu prueba de fondeo.&lt;/p&gt;&lt;/header&gt;
                &lt;div class=&quot;space-y-8&quot;&gt;
                    &lt;div class=&quot;bg-white p-6 rounded-xl border border-slate-200&quot;&gt;&lt;h3 class=&quot;text-xl font-bold text-slate-900 mb-4&quot;&gt;Configuración del Desafío&lt;/h3&gt;
                        &lt;div&gt;
                            &lt;label for=&quot;initial-balance&quot; class=&quot;block text-sm font-medium text-slate-700&quot;&gt;Balance Inicial del Desafío ($)&lt;/label&gt;
                            &lt;input type=&quot;number&quot; id=&quot;initial-balance&quot; value=&quot;100000&quot; class=&quot;mt-1 block w-full md:w-1/2 rounded-md border-slate-300 shadow-sm focus:border-sky-500 focus:ring-sky-500&quot;&gt;
                            &lt;p class=&quot;mt-1 text-xs text-slate-500&quot;&gt;Puedes editar este valor para ajustar tu simulación.&lt;/p&gt;
                        &lt;/div&gt;
                    &lt;/div&gt;
                    &lt;div class=&quot;bg-white p-6 rounded-xl border border-slate-200&quot;&gt;&lt;h3 class=&quot;text-xl font-bold text-slate-900 mb-4&quot;&gt;Sección 3: Gestión de Riesgo y Capital (Reglas FTMO)&lt;/h3&gt;&lt;ul class=&quot;list-disc list-inside space-y-3 text-slate-600&quot;&gt;&lt;li&gt;&lt;strong&gt;Riesgo Máximo por Operación:&lt;/strong&gt; 0,5% de la cuenta.&lt;/li&gt;&lt;li class=&quot;font-bold&quot;&gt;&lt;strong&gt;Pérdida Máxima Diaria:&lt;/strong&gt; 5% del balance inicial. Si se alcanza, se falla el desafío.&lt;/li&gt;&lt;li class=&quot;font-bold&quot;&gt;&lt;strong&gt;Pérdida Máxima Total (Drawdown):&lt;/strong&gt; 10% del balance inicial. Si se alcanza, se falla el desafío.&lt;/li&gt;&lt;/ul&gt;&lt;/div&gt;
                    &lt;div class=&quot;bg-white p-6 rounded-xl border border-slate-200&quot;&gt;&lt;h3 class=&quot;text-xl font-bold text-slate-900 mb-4&quot;&gt;Sección 1: Mi Manifiesto&lt;/h3&gt;&lt;div class=&quot;space-y-3 text-slate-600&quot;&gt;&lt;p&gt;&lt;strong&gt;Mi Porqué:&lt;/strong&gt; Tiempo con mi familia, libertad, ser un proveedor formidable.&lt;/p&gt;&lt;p&gt;&lt;strong&gt;Mi Perfil de Trader:&lt;/strong&gt; Intradía / Scalper.&lt;/p&gt;&lt;/div&gt;&lt;/div&gt;
                &lt;/div&gt;
            &lt;/div&gt;

            &lt;!-- Revisión Semanal View --&gt;
            &lt;div id=&quot;view-review&quot; class=&quot;hidden&quot;&gt;
                &lt;header class=&quot;mb-8&quot;&gt;&lt;h2 class=&quot;text-3xl font-bold text-slate-900&quot;&gt;Revisión Semanal&lt;/h2&gt;&lt;p class=&quot;text-slate-500 mt-1&quot;&gt;Tu ritual de mejora. Enfréntate a tu mayor oponente: tú mismo.&lt;/p&gt;&lt;/header&gt;
                &lt;div class=&quot;bg-white p-6 rounded-xl border border-slate-200&quot;&gt;&lt;h3 class=&quot;text-xl font-bold text-slate-900 mb-4&quot;&gt;Semana del &lt;span id=&quot;review-date&quot;&gt;&lt;/span&gt;&lt;/h3&gt;&lt;div class=&quot;space-y-6&quot;&gt;&lt;div&gt;&lt;label class=&quot;font-bold text-slate-700&quot;&gt;1. Resultados de la Semana&lt;/label&gt;&lt;textarea class=&quot;w-full mt-2 p-2 border border-slate-300 rounded-md h-24&quot; placeholder=&quot;Resultado Neto ($ y R), Win Rate, Número de Operaciones...&quot;&gt;&lt;/textarea&gt;&lt;/div&gt;&lt;div&gt;&lt;label class=&quot;font-bold text-slate-700&quot;&gt;2. Análisis de Ejecución&lt;/label&gt;&lt;textarea class=&quot;w-full mt-2 p-2 border border-slate-300 rounded-md h-32&quot; placeholder=&quot;Mi Mejor Operación (por ejecución): ¿Por qué?&amp;#10;Mi Peor Operación (por indisciplina): ¿Qué regla rompí? ¿Por qué?&quot;&gt;&lt;/textarea&gt;&lt;/div&gt;&lt;div&gt;&lt;label class=&quot;font-bold text-slate-700&quot;&gt;3. Reflexión Estoica&lt;/label&gt;&lt;textarea class=&quot;w-full mt-2 p-2 border border-slate-300 rounded-md h-32&quot; placeholder=&quot;¿Qué patrón (mental o de mercado) se repitió?&amp;#10;¿Qué factor externo (cansancio, estrés) afectó mi trading?&amp;#10;¿Qué está bajo mi control que puedo mejorar?&quot;&gt;&lt;/textarea&gt;&lt;/div&gt;&lt;div&gt;&lt;label class=&quot;font-bold text-slate-700&quot;&gt;4. Plan de Acción para la Próxima Semana&lt;/label&gt;&lt;textarea class=&quot;w-full mt-2 p-2 border border-slate-300 rounded-md h-24&quot; placeholder=&quot;Un ÚNICO Objetivo de Mejora (Ej: No operar después de 2 pérdidas seguidas).&quot;&gt;&lt;/textarea&gt;&lt;/div&gt;&lt;button class=&quot;bg-sky-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-sky-700 transition-colors&quot;&gt;Guardar Revisión&lt;/button&gt;&lt;/div&gt;&lt;/div&gt;
            &lt;/div&gt;
        &lt;/main&gt;
    &lt;/div&gt;

    &lt;!-- Add Trade Modal --&gt;
    &lt;div id=&quot;trade-modal&quot; class=&quot;modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4 z-50&quot;&gt;
        &lt;div class=&quot;bg-white rounded-xl p-8 w-full max-w-lg max-h-full overflow-y-auto&quot;&gt;&lt;h2 class=&quot;text-2xl font-bold text-slate-900 mb-6&quot;&gt;Añadir Nueva Operación&lt;/h2&gt;&lt;form id=&quot;trade-form&quot; class=&quot;space-y-4&quot;&gt;
            &lt;div class=&quot;grid grid-cols-1 md:grid-cols-2 gap-4&quot;&gt;
                &lt;div&gt;&lt;label for=&quot;trade-date&quot; class=&quot;block text-sm font-medium text-slate-700&quot;&gt;Fecha&lt;/label&gt;&lt;input type=&quot;date&quot; id=&quot;trade-date&quot; class=&quot;mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-sky-500 focus:ring-sky-500&quot; required&gt;&lt;/div&gt;
                &lt;div&gt;&lt;label for=&quot;trade-time&quot; class=&quot;block text-sm font-medium text-slate-700&quot;&gt;Hora (GMT-3)&lt;/label&gt;&lt;input type=&quot;time&quot; id=&quot;trade-time&quot; class=&quot;mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-sky-500 focus:ring-sky-500&quot; required&gt;&lt;/div&gt;
            &lt;/div&gt;
            &lt;div class=&quot;grid grid-cols-1 md:grid-cols-2 gap-4&quot;&gt;
                 &lt;div&gt;
                    &lt;label for=&quot;trade-pair&quot; class=&quot;block text-sm font-medium text-slate-700&quot;&gt;Par / Instrumento&lt;/label&gt;
                    &lt;input type=&quot;text&quot; id=&quot;trade-pair&quot; list=&quot;pair-list&quot; class=&quot;mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-sky-500 focus:ring-sky-500&quot; required&gt;
                    &lt;datalist id=&quot;pair-list&quot;&gt;&lt;/datalist&gt;
                &lt;/div&gt;
                &lt;div&gt;&lt;label for=&quot;trade-direction&quot; class=&quot;block text-sm font-medium text-slate-700&quot;&gt;Dirección&lt;/label&gt;&lt;select id=&quot;trade-direction&quot; class=&quot;mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-sky-500 focus:ring-sky-500&quot;&gt;&lt;option value=&quot;Largo&quot;&gt;Largo&lt;/option&gt;&lt;option value=&quot;Corto&quot;&gt;Corto&lt;/option&gt;&lt;/select&gt;&lt;/div&gt;
            &lt;/div&gt;
            &lt;div class=&quot;grid grid-cols-1&quot;&gt;
                &lt;div&gt;&lt;label for=&quot;trade-setup&quot; class=&quot;block text-sm font-medium text-slate-700&quot;&gt;Setup&lt;/label&gt;&lt;input type=&quot;text&quot; id=&quot;trade-setup&quot; placeholder=&quot;Ej: Ruptura M15 + Retesteo OB&quot; class=&quot;mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-sky-500 focus:ring-sky-500&quot; required&gt;&lt;/div&gt;
            &lt;/div&gt;
            &lt;div class=&quot;grid grid-cols-1 md:grid-cols-2 gap-4&quot;&gt;
                &lt;div&gt;&lt;label for=&quot;trade-risk&quot; class=&quot;block text-sm font-medium text-slate-700&quot;&gt;Riesgo ($)&lt;/label&gt;&lt;input type=&quot;number&quot; step=&quot;0.01&quot; id=&quot;trade-risk&quot; placeholder=&quot;500&quot; class=&quot;mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-sky-500 focus:ring-sky-500&quot; required&gt;&lt;/div&gt;
                &lt;div&gt;&lt;label for=&quot;trade-result&quot; class=&quot;block text-sm font-medium text-slate-700&quot;&gt;Resultado ($)&lt;/label&gt;&lt;input type=&quot;number&quot; step=&quot;0.01&quot; id=&quot;trade-result&quot; placeholder=&quot;1500&quot; class=&quot;mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-sky-500 focus:ring-sky-500&quot; required&gt;&lt;/div&gt;
            &lt;/div&gt;
            &lt;div class=&quot;grid grid-cols-1 md:grid-cols-2 gap-4&quot;&gt;
                 &lt;div&gt;&lt;label for=&quot;trade-planned-rr&quot; class=&quot;block text-sm font-medium text-slate-700&quot;&gt;R:R Esperado (Ej: 3 para 1:3)&lt;/label&gt;&lt;input type=&quot;number&quot; step=&quot;0.1&quot; id=&quot;trade-planned-rr&quot; placeholder=&quot;3&quot; class=&quot;mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-sky-500 focus:ring-sky-500&quot; required&gt;&lt;/div&gt;
                 &lt;div&gt;&lt;label for=&quot;trade-achieved-rr&quot; class=&quot;block text-sm font-medium text-slate-700&quot;&gt;R:R Obtenido (Calculado)&lt;/label&gt;&lt;input type=&quot;text&quot; id=&quot;trade-achieved-rr&quot; class=&quot;mt-1 block w-full rounded-md border-slate-300 bg-slate-100 shadow-sm&quot; readonly&gt;&lt;/div&gt;
            &lt;/div&gt;
             &lt;div class=&quot;grid grid-cols-1&quot;&gt;
                 &lt;div&gt;&lt;label for=&quot;trade-discipline&quot; class=&quot;block text-sm font-medium text-slate-700&quot;&gt;Puntuación de Disciplina (1-5)&lt;/label&gt;&lt;input type=&quot;number&quot; id=&quot;trade-discipline&quot; min=&quot;1&quot; max=&quot;5&quot; placeholder=&quot;5&quot; class=&quot;mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-sky-500 focus:ring-sky-500&quot; required&gt;&lt;/div&gt;
            &lt;/div&gt;
            &lt;div&gt;&lt;label for=&quot;trade-screenshot&quot; class=&quot;block text-sm font-medium text-slate-700&quot;&gt;URL de la Captura (Opcional)&lt;/label&gt;&lt;input type=&quot;url&quot; id=&quot;trade-screenshot&quot; placeholder=&quot;https://i.imgur.com/...&quot; class=&quot;mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-sky-500 focus:ring-sky-500&quot;&gt;&lt;p class=&quot;mt-1 text-xs text-slate-500&quot;&gt;Sube tu imagen a un servicio como Imgur y pega el enlace directo aquí.&lt;/p&gt;&lt;/div&gt;
            &lt;div class=&quot;flex justify-end space-x-4 pt-4&quot;&gt;&lt;button type=&quot;button&quot; id=&quot;cancel-trade-btn&quot; class=&quot;bg-slate-200 text-slate-800 font-bold py-2 px-4 rounded-lg hover:bg-slate-300 transition-colors&quot;&gt;Cancelar&lt;/button&gt;&lt;button type=&quot;submit&quot; class=&quot;bg-sky-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-sky-700 transition-colors&quot;&gt;Guardar Operación&lt;/button&gt;&lt;/div&gt;
        &lt;/form&gt;&lt;/div&gt;
    &lt;/div&gt;

&lt;script type=&quot;module&quot;&gt;
    import { initializeApp } from &quot;https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js&quot;;
    import { getFirestore, collection, addDoc, onSnapshot, doc, setDoc, getDoc, query, orderBy } from &quot;https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js&quot;;
    import { getAuth, signInAnonymously, onAuthStateChanged } from &quot;https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js&quot;;
   
 const firebaseConfig = {
  apiKey: &quot;AIzaSyDwbpN2FWpSrk91QXjKE0483qIfcL4T-fk&quot;,
  authDomain: &quot;diario-de-tradig.firebaseapp.com&quot;,
  projectId: &quot;diario-de-tradig&quot;,
  storageBucket: &quot;diario-de-tradig.firebasestorage.app&quot;,
  messagingSenderId: &quot;190986085980&quot;,
  appId: &quot;1:190986085980:web:ac00b98e9e3f5da3bc2899&quot;,
  measurementId: &quot;G-7SD6M9NYBZ&quot;
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let trades = [];
    let initialBalance = 100000;
    let currentDate = new Date();
    let currentUser = null;
    let unsubscribe = null; 

    let charts = {};

    const views = { dashboard: document.getElementById('view-dashboard'), analysis: document.getElementById('view-analysis'), calendar: document.getElementById('view-calendar'), plan: document.getElementById('view-plan'), review: document.getElementById('view-review') };
    const navLinks = { dashboard: document.getElementById('nav-dashboard'), analysis: document.getElementById('nav-analysis'), calendar: document.getElementById('nav-calendar'), plan: document.getElementById('nav-plan'), review: document.getElementById('nav-review') };
    const tradeModal = document.getElementById('trade-modal');
    const addTradeBtn = document.getElementById('add-trade-btn');
    const cancelTradeBtn = document.getElementById('cancel-trade-btn');
    const tradeForm = document.getElementById('trade-form');
    const tradeLogBody = document.getElementById('trade-log-body');
    const calendarGrid = document.getElementById('calendar-grid');
    const calendarMonthYear = document.getElementById('calendar-month-year');
    const prevMonthBtn = document.getElementById('prev-month-btn');
    const nextMonthBtn = document.getElementById('next-month-btn');
    const initialBalanceInput = document.getElementById('initial-balance');
    const tradeRiskInput = document.getElementById('trade-risk');
    const tradeResultInput = document.getElementById('trade-result');
    const tradeAchievedRRInput = document.getElementById('trade-achieved-rr');
    const pairList = document.getElementById('pair-list');
    
    function switchView(viewName) {
        Object.values(views).forEach(v =&gt; v.classList.add('hidden'));
        Object.values(navLinks).forEach(l =&gt; l.classList.remove('active'));
        views[viewName].classList.remove('hidden');
        navLinks[viewName].classList.add('active');
        if (viewName === 'calendar') renderCalendar();
        if (viewName === 'dashboard') renderCharts();
        if (viewName === 'analysis') renderAnalysisCharts();
    }

    Object.keys(navLinks).forEach(key =&gt; {
        navLinks[key].addEventListener('click', () =&gt; switchView(key));
    });

    addTradeBtn.addEventListener('click', () =&gt; {
        tradeForm.reset();
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        document.getElementById('trade-date').value = now.toISOString().slice(0,10);
        document.getElementById('trade-time').value = now.toISOString().slice(11,16);
        updateAchievedRR();
        tradeModal.classList.add('open');
    });
    cancelTradeBtn.addEventListener('click', () =&gt; tradeModal.classList.remove('open'));
    tradeModal.addEventListener('click', (e) =&gt; {
        if (e.target === tradeModal) tradeModal.classList.remove('open');
    });

    initialBalanceInput.addEventListener('change', async (e) =&gt; {
        initialBalance = parseFloat(e.target.value) || 100000;
        if (currentUser) {
            const userDocRef = doc(db, 'users', currentUser.uid);
            await setDoc(userDocRef, { initialBalance }, { merge: true });
        }
        updateAll();
    });

    function updateAchievedRR() {
        const risk = parseFloat(tradeRiskInput.value);
        const result = parseFloat(tradeResultInput.value);
        if (risk &amp;&amp; risk !== 0) {
            const achievedRR = result / risk;
            tradeAchievedRRInput.value = `${achievedRR.toFixed(2)}R`;
        } else {
            tradeAchievedRRInput.value = 'N/A';
        }
    }

    tradeRiskInput.addEventListener('input', updateAchievedRR);
    tradeResultInput.addEventListener('input', updateAchievedRR);

    function updatePairDatalist() {
        const defaultPairs = [&quot;EUR/USD&quot;, &quot;GBP/USD&quot;, &quot;USD/JPY&quot;, &quot;USD/CHF&quot;, &quot;AUD/USD&quot;, &quot;NZD/USD&quot;, &quot;USD/CAD&quot;, &quot;XAU/USD&quot;, &quot;US30&quot;, &quot;NAS100&quot;];
        const tradedPairs = trades.map(t =&gt; t.pair.toUpperCase());
        const allPairs = [...new Set([...defaultPairs, ...tradedPairs])];
        pairList.innerHTML = allPairs.map(p =&gt; `&lt;option value=&quot;${p}&quot;&gt;`).join('');
    }

    function getSession(hour) {
        if (hour &gt;= 9 &amp;&amp; hour &lt; 13) return 'Londres &amp; NY';
        if (hour &gt;= 4 &amp;&amp; hour &lt; 6) return 'Londres &amp; Tokio';
        if (hour &gt;= 21 || hour &lt; 3) return 'Sydney &amp; Tokio';
        if (hour &gt;= 18 &amp;&amp; hour &lt; 21) return 'Sydney';
        if (hour &gt;= 3 &amp;&amp; hour &lt; 4) return 'Tokio';
        if (hour &gt;= 6 &amp;&amp; hour &lt; 9) return 'Londres';
        if (hour &gt;= 13 &amp;&amp; hour &lt; 18) return 'Nueva York';
        return 'Fuera de Sesión';
    }

    function renderCalendar() {
        const month = currentDate.getMonth();
        const year = currentDate.getFullYear();
        calendarMonthYear.textContent = `${currentDate.toLocaleString('es-ES', { month: 'long' })} ${year}`;
        calendarGrid.innerHTML = '';
        const firstDayOfMonth = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const dailyTotals = trades.reduce((acc, trade) =&gt; {
            const tradeDate = new Date(trade.date + 'T' + (trade.time || '00:00:00'));
            if (tradeDate.getFullYear() === year &amp;&amp; tradeDate.getMonth() === month) {
                const day = tradeDate.getDate();
                if (!acc[day]) acc[day] = 0;
                acc[day] += trade.result;
            }
            return acc;
        }, {});
        const startDayOfWeek = (firstDayOfMonth === 0) ? 6 : firstDayOfMonth - 1;
        for (let i = 0; i &lt; startDayOfWeek; i++) calendarGrid.appendChild(document.createElement('div'));
        for (let day = 1; day &lt;= daysInMonth; day++) {
            const dayCell = document.createElement('div');
            dayCell.className = 'calendar-day border border-slate-200 p-2 flex flex-col';
            const dayNumber = document.createElement('span');
            dayNumber.textContent = day;
            dayNumber.className = 'font-semibold text-slate-600';
            dayCell.appendChild(dayNumber);
            if (dailyTotals[day] !== undefined) {
                const result = dailyTotals[day];
                const resultEl = document.createElement('div');
                resultEl.className = 'mt-auto text-center rounded p-1 text-sm font-bold';
                if (result &gt; 0) { resultEl.classList.add('bg-green-100', 'text-green-800'); resultEl.textContent = `+$${result.toFixed(2)}`; } 
                else if (result &lt; 0) { resultEl.classList.add('bg-red-100', 'text-red-800'); resultEl.textContent = `-$${Math.abs(result).toFixed(2)}`; } 
                else { resultEl.classList.add('bg-slate-100', 'text-slate-800'); resultEl.textContent = `$0.00`; }
                dayCell.appendChild(resultEl);
            }
            const today = new Date();
            if (day === today.getDate() &amp;&amp; month === today.getMonth() &amp;&amp; year === today.getFullYear()) dayNumber.classList.add('bg-sky-600', 'text-white', 'rounded-full', 'w-6', 'h-6', 'flex', 'items-center', 'justify-center');
            calendarGrid.appendChild(dayCell);
        }
    }

    prevMonthBtn.addEventListener('click', () =&gt; { currentDate.setMonth(currentDate.getMonth() - 1); renderCalendar(); });
    nextMonthBtn.addEventListener('click', () =&gt; { currentDate.setMonth(currentDate.getMonth() + 1); renderCalendar(); });

    function calculateKPIs() {
        if (trades.length === 0) return { profitFactor: 0, winRate: 0, avgRR: 0, expectancy: 0, challengeStatus: { status: 'Active', message: 'No trades yet.' }, maxDrawdown: 0 };
        
        const sortedTrades = [...trades].sort((a,b) =&gt; new Date(a.date + 'T' + a.time) - new Date(b.date + 'T' + b.time));
        let peak = initialBalance;
        let maxDrawdown = 0;
        let currentBalance = initialBalance;
        let challengeStatus = { status: 'Active', message: 'Desafío en curso.' };
        const dailyLossLimit = initialBalance * 0.05;
        const maxLossLimit = initialBalance * 0.10;

        const dailyPnl = {};
        for(const trade of sortedTrades) {
            if(challengeStatus.status !== 'Active') continue;
            const dateStr = trade.date;
            if(!dailyPnl[dateStr]) dailyPnl[dateStr] = 0;
            dailyPnl[dateStr] += trade.result;
            currentBalance += trade.result;
            peak = Math.max(peak, currentBalance);
            const drawdown = peak - currentBalance;
            maxDrawdown = Math.max(maxDrawdown, drawdown);
            if (dailyPnl[dateStr] &lt; -dailyLossLimit) {
                challengeStatus = { status: 'Failed', message: `Pérdida diaria excedida el ${dateStr}` };
            }
            if (maxDrawdown &gt;= maxLossLimit) {
                challengeStatus = { status: 'Failed', message: `Pérdida máxima excedida` };
            }
        }

        const winningTrades = trades.filter(t =&gt; t.result &gt; 0);
        const losingTrades = trades.filter(t =&gt; t.result &lt;= 0);
        const grossProfit = winningTrades.reduce((sum, t) =&gt; sum + t.result, 0);
        const grossLoss = Math.abs(losingTrades.reduce((sum, t) =&gt; sum + t.result, 0));
        const profitFactor = grossLoss &gt; 0 ? (grossProfit / grossLoss) : Infinity;
        const winRate = (winningTrades.length / trades.length) * 100;
        const avgWin = winningTrades.length &gt; 0 ? grossProfit / winningTrades.length : 0;
        const avgLoss = losingTrades.length &gt; 0 ? grossLoss / losingTrades.length : 0;
        const expectancy = (winRate / 100 * avgWin) - ((100 - winRate) / 100 * avgLoss);
        const totalR = trades.reduce((sum, t) =&gt; sum + (t.risk !== 0 ? t.result / t.risk : 0), 0);
        const avgRR = totalR / trades.length;
        
        return { profitFactor, winRate, avgRR, expectancy, challengeStatus, maxDrawdown };
    }

    function updateUI() {
        const kpis = calculateKPIs();
        
        document.getElementById('kpi-profit-factor').textContent = isFinite(kpis.profitFactor) ? kpis.profitFactor.toFixed(2) : '∞';
        document.getElementById('kpi-win-rate').textContent = `${kpis.winRate.toFixed(1)}%`;
        document.getElementById('kpi-avg-rr').textContent = `${kpis.avgRR.toFixed(2)}R`;
        document.getElementById('kpi-expectancy').textContent = `$${kpis.expectancy.toFixed(2)}`;
        
        const badge = document.getElementById('challenge-status-badge');
        if(kpis.challengeStatus.status === 'Active') {
            badge.textContent = 'ACTIVO';
            badge.className = 'px-3 py-1 text-sm font-bold rounded-full bg-green-100 text-green-800';
            addTradeBtn.disabled = false;
        } else {
            badge.textContent = 'FALLADO';
            badge.className = 'px-3 py-1 text-sm font-bold rounded-full bg-red-100 text-red-800';
            addTradeBtn.disabled = true;
        }
        
        const dailyLossLimit = initialBalance * 0.05;
        const maxLossLimit = initialBalance * 0.10;
        document.getElementById('status-initial-balance').textContent = `$${initialBalance.toLocaleString()}`;
        document.getElementById('status-daily-loss-limit').textContent = `-$${dailyLossLimit.toLocaleString()}`;
        document.getElementById('status-max-loss-limit').textContent = `-$${maxLossLimit.toLocaleString()}`;
        document.getElementById('status-current-drawdown').textContent = `-$${kpis.maxDrawdown.toFixed(2)}`;

        renderTradeLog();
        renderCharts();
        renderAnalysisCharts();
        updatePairDatalist();
        if (!views.calendar.classList.contains('hidden')) renderCalendar();
    }

    function renderTradeLog() {
        tradeLogBody.innerHTML = '';
        if (trades.length === 0) {
            tradeLogBody.innerHTML = `&lt;tr&gt;&lt;td colspan=&quot;8&quot; class=&quot;text-center py-8 text-slate-500&quot;&gt;No hay operaciones registradas. ¡Añade una para empezar!&lt;/td&gt;&lt;/tr&gt;`;
            return;
        }
        trades.slice().sort((a, b) =&gt; new Date(b.date) - new Date(a.date)).forEach(trade =&gt; {
            const resultR = trade.risk !== 0 ? trade.result / trade.risk : 0;
            const row = document.createElement('tr');
            row.className = 'bg-white border-b';
            let screenshotCell = '&lt;td&gt;&lt;/td&gt;';
            if (trade.screenshotUrl) screenshotCell = `&lt;td class=&quot;px-6 py-4 text-center&quot;&gt;&lt;a href=&quot;${trade.screenshotUrl}&quot; target=&quot;_blank&quot; class=&quot;text-sky-600 hover:text-sky-800&quot;&gt;&lt;svg xmlns=&quot;http://www.w3.org/2000/svg&quot; class=&quot;h-6 w-6 mx-auto&quot; fill=&quot;none&quot; viewBox=&quot;0 0 24 24&quot; stroke=&quot;currentColor&quot; stroke-width=&quot;2&quot;&gt;&lt;path stroke-linecap=&quot;round&quot; stroke-linejoin=&quot;round&quot; d=&quot;M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z&quot; /&gt;&lt;path stroke-linecap=&quot;round&quot; stroke-linejoin=&quot;round&quot; d=&quot;M15 13a3 3 0 11-6 0 3 3 0 016 0z&quot; /&gt;&lt;/svg&gt;&lt;/a&gt;&lt;/td&gt;`;
            row.innerHTML = `&lt;td class=&quot;px-6 py-4&quot;&gt;${trade.date}&lt;/td&gt;&lt;td class=&quot;px-6 py-4 font-medium text-slate-900&quot;&gt;${trade.pair}&lt;/td&gt;&lt;td class=&quot;px-6 py-4&quot;&gt;1:${trade.plannedRR}&lt;/td&gt;&lt;td class=&quot;px-6 py-4 font-medium ${resultR &gt; 0 ? 'text-green-600' : 'text-red-600'}&quot;&gt;${resultR.toFixed(2)}R&lt;/td&gt;&lt;td class=&quot;px-6 py-4 font-medium ${trade.result &gt; 0 ? 'text-green-600' : 'text-red-600'}&quot;&gt;$${trade.result.toFixed(2)}&lt;/td&gt;&lt;td class=&quot;px-6 py-4&quot;&gt;${'★'.repeat(trade.discipline)}${'☆'.repeat(5 - trade.discipline)}&lt;/td&gt;${screenshotCell}`;
            tradeLogBody.appendChild(row);
        });
    }

    function createOrUpdateChart(id, type, data, options) {
        const canvas = document.getElementById(id);
        if (!canvas) return;
        const ctx = canvas.getContext('2d');
        if (charts[id]) charts[id].destroy();
        charts[id] = new Chart(ctx, { type, data, options });
    }

    function renderCharts() {
        if (views.dashboard.classList.contains('hidden')) return;
        if (trades.length === 0) {
            Object.values(charts).forEach(chart =&gt; { if(chart) chart.destroy(); });
            charts = {};
            return;
        }
        let balance = initialBalance;
        const equityData = trades.slice().sort((a,b) =&gt; new Date(a.date) - new Date(b.date)).map(t =&gt; balance += t.result);
        createOrUpdateChart('equity-curve-chart', 'line', { labels: equityData.map((_, i) =&gt; `T${i+1}`), datasets: [{ label: 'Curva de Capital ($)', data: equityData, borderColor: '#0ea5e9', backgroundColor: 'rgba(14, 165, 233, 0.1)', fill: true, tension: 0.1 }] }, { responsive: true, maintainAspectRatio: false });
        createOrUpdateChart('discipline-chart', 'bar', { labels: trades.map(t =&gt; `T${t.id}`), datasets: [{ type: 'bar', label: 'Resultado ($)', data: trades.map(t =&gt; t.result), backgroundColor: trades.map(t =&gt; t.result &gt; 0 ? 'rgba(22, 163, 74, 0.6)' : 'rgba(220, 38, 38, 0.6)') }, { type: 'line', label: 'Disciplina (1-5)', data: trades.map(t =&gt; t.discipline), borderColor: '#f59e0b', yAxisID: 'y1', tension: 0.3 }] }, { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: false, position: 'left', title: { display: true, text: 'Resultado ($)' } }, y1: { beginAtZero: true, position: 'right', min: 0, max: 6, grid: { drawOnChartArea: false }, title: { display: true, text: 'Disciplina' } } } });
    }

    function renderAnalysisCharts() {
        if (views.analysis.classList.contains('hidden')) return;
        if (trades.length === 0) return;

        // Buy vs Sell
        const buys = trades.filter(t =&gt; t.direction === 'Largo');
        const sells = trades.filter(t =&gt; t.direction === 'Corto');
        const buyWins = buys.filter(t =&gt; t.result &gt; 0).length;
        const sellWins = sells.filter(t =&gt; t.result &gt; 0).length;
        const buyWR = buys.length &gt; 0 ? (buyWins / buys.length) * 100 : 0;
        const sellWR = sells.length &gt; 0 ? (sellWins / sells.length) * 100 : 0;
        document.getElementById('analysis-buy-wr').textContent = `${buyWR.toFixed(1)}%`;
        document.getElementById('analysis-sell-wr').textContent = `${sellWR.toFixed(1)}%`;
        createOrUpdateChart('analysis-buysell-chart', 'doughnut', {
            labels: ['Compras Ganadoras', 'Compras Perdedoras', 'Ventas Ganadoras', 'Ventas Perdedoras'],
            datasets: [{
                data: [buyWins, buys.length - buyWins, sellWins, sells.length - sellWins],
                backgroundColor: ['#16a34a', '#b91c1c', '#22c55e', '#ef4444']
            }]
        }, { responsive: true, maintainAspectRatio: false });

        // Session
        const sessionPnl = {};
        trades.forEach(t =&gt; {
            const hour = parseInt(t.time.split(':')[0]);
            const session = getSession(hour);
            if (!sessionPnl[session]) sessionPnl[session] = 0;
            sessionPnl[session] += t.result;
        });
        createOrUpdateChart('analysis-session-chart', 'bar', {
            labels: Object.keys(sessionPnl),
            datasets: [{
                label: 'Resultado Neto por Sesión ($)',
                data: Object.values(sessionPnl),
                backgroundColor: Object.values(sessionPnl).map(v =&gt; v &gt; 0 ? 'rgba(34, 197, 94, 0.7)' : 'rgba(239, 68, 68, 0.7)')
            }]
        }, { responsive: true, maintainAspectRatio: false });

        // Pair Performance
        const performanceByPair = trades.reduce((acc, t) =&gt; { if (!acc[t.pair]) acc[t.pair] = 0; acc[t.pair] += t.result; return acc; }, {});
        createOrUpdateChart('analysis-pair-chart', 'bar', { labels: Object.keys(performanceByPair), datasets: [{ label: 'Resultado Neto por Instrumento ($)', data: Object.values(performanceByPair), backgroundColor: Object.values(performanceByPair).map(v =&gt; v &gt; 0 ? 'rgba(34, 197, 94, 0.7)' : 'rgba(239, 68, 68, 0.7)') }] }, { responsive: true, maintainAspectRatio: false, indexAxis: 'y' });
    }

    tradeForm.addEventListener('submit', async (e) =&gt; {
        e.preventDefault();
        if (!currentUser) {
            alert(&quot;Error: No estás autenticado.&quot;);
            return;
        }
        const newTrade = { 
            date: document.getElementById('trade-date').value, 
            time: document.getElementById('trade-time').value,
            pair: document.getElementById('trade-pair').value.toUpperCase(), 
            direction: document.getElementById('trade-direction').value, 
            setup: document.getElementById('trade-setup').value, 
            risk: parseFloat(document.getElementById('trade-risk').value), 
            result: parseFloat(document.getElementById('trade-result').value), 
            discipline: parseInt(document.getElementById('trade-discipline').value), 
            plannedRR: parseFloat(document.getElementById('trade-planned-rr').value),
            screenshotUrl: document.getElementById('trade-screenshot').value.trim() 
        };
        
        const tradesCollectionRef = collection(db, 'users', currentUser.uid, 'trades');
        await addDoc(tradesCollectionRef, newTrade);

        tradeForm.reset();
        tradeModal.classList.remove('open');
    });

    function setupRealtimeListener(userId) {
        if (unsubscribe) unsubscribe(); 
        
        const userDocRef = doc(db, 'users', userId);
        const tradesCollectionRef = collection(userDocRef, 'trades');
        const q = query(tradesCollectionRef, orderBy(&quot;date&quot;, &quot;desc&quot;));

        getDoc(userDocRef).then(docSnap =&gt; {
            if (docSnap.exists()) {
                initialBalance = docSnap.data().initialBalance || 100000;
            } else {
                setDoc(userDocRef, { initialBalance: 100000 });
            }
            initialBalanceInput.value = initialBalance;

            unsubscribe = onSnapshot(q, (snapshot) =&gt; {
                trades = snapshot.docs.map(doc =&gt; ({ id: doc.id, ...doc.data() }));
                updateAll();
            });
        });
    }

    onAuthStateChanged(auth, (user) =&gt; {
        if (user) {
            currentUser = user;
            setupRealtimeListener(user.uid);
        } else {
            signInAnonymously(auth).catch((error) =&gt; {
                console.error(&quot;Error signing in anonymously&quot;, error);
            });
        }
    });

    function updateAll() {
        updateUI();
    }
    
    const todayForReview = new Date();
    const weekStart = new Date(todayForReview.setDate(todayForReview.getDate() - todayForReview.getDay() + 1));
    const weekEnd = new Date(todayForReview.setDate(todayForReview.getDate() - todayForReview.getDay() + 7));
    document.getElementById('review-date').textContent = `${weekStart.toLocaleDateString()} al ${weekEnd.toLocaleDateString()}`;
    
&lt;/script&gt;

&lt;/body&gt;
&lt;/html&gt;</pre>
</body>
</html>