<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diario de Trading Interactivo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .chart-container { position: relative; width: 100%; height: 320px; max-height: 400px; }
        @media (min-width: 768px) { .chart-container { height: 400px; } }
        .nav-link { display: flex; align-items: center; padding: 0.75rem 1rem; border-radius: 0.5rem; transition: background-color 0.2s, color 0.2s; cursor: pointer; font-weight: 500; }
        .nav-link.active { background-color: #e0f2fe; color: #0c4a6e; font-weight: 600; }
        .nav-link:not(.active):hover { background-color: #f1f5f9; }
        .modal { display: none; }
        .modal.open { display: flex; }
        .calendar-day { min-height: 120px; }
        .filter-btn.active { background-color: #0c4a6e; color: white; }
    </style>
</head>
<body class="text-slate-800">

    <!-- Auth Overlay -->
    <div id="auth-overlay" class="fixed inset-0 bg-slate-900 bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm">
            <h2 class="text-2xl font-bold text-slate-900 text-center">Bienvenido a tu Fortaleza</h2>
            <p class="text-slate-500 mt-2 mb-6 text-center">Inicia sesión o regístrate para continuar.</p>
            <form id="auth-form" class="space-y-4">
                <div>
                    <label for="email" class="block text-sm font-medium text-slate-700 text-left">Email</label>
                    <input type="email" id="email" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-sky-500 focus:ring-sky-500" required>
                </div>
                <div>
                    <label for="password" class="block text-sm font-medium text-slate-700 text-left">Contraseña</label>
                    <input type="password" id="password" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-sky-500 focus:ring-sky-500" required>
                </div>
                <div id="auth-error" class="text-red-600 text-sm text-center h-4"></div>
                <div class="flex space-x-4 pt-2">
                    <button type="button" id="login-btn" class="w-full bg-sky-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-sky-700 transition-colors">Iniciar Sesión</button>
                    <button type="button" id="register-btn" class="w-full bg-slate-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-slate-700 transition-colors">Registrarse</button>
                </div>
            </form>
        </div>
    </div>

    <div id="app-container" class="flex h-screen bg-slate-50 opacity-0 transition-opacity duration-500">
        <!-- Sidebar Navigation -->
        <aside class="w-64 bg-white border-r border-slate-200 flex-shrink-0 flex flex-col">
            <div>
                <div class="p-4">
                    <h1 class="text-2xl font-bold text-slate-900">Fortaleza</h1>
                    <p class="text-sm text-slate-500">Simulador de Fondeo</p>
                </div>
                <nav class="p-2">
                    <a id="nav-dashboard" class="nav-link active"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 20 20" fill="currentColor"><path d="M2 10a8 8 0 018-8v8h8a8 8 0 11-16 0z" /><path d="M12 2.252A8.014 8.014 0 0117.748 8H12V2.252z" /></svg>Dashboard</a>
                    <a id="nav-analysis" class="nav-link"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 20 20" fill="currentColor"><path d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z" /></svg>Análisis</a>
                    <a id="nav-calendar" class="nav-link"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" /></svg>Calendario</a>
                    <a id="nav-plan" class="nav-link"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg>Plan de Trading</a>
                    <a id="nav-review" class="nav-link"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 20 20" fill="currentColor"><path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" /><path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd" /></svg>Revisión Semanal</a>
                    <a id="nav-archive" class="nav-link"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 20 20" fill="currentColor"><path d="M4 3a2 2 0 100 4h12a2 2 0 100-4H4z" /><path fill-rule="evenodd" d="M3 8h14v7a2 2 0 01-2 2H5a2 2 0 01-2-2V8zm5 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" clip-rule="evenodd" /></svg>Archivo</a>
                </nav>
            </div>
            <div class="p-4 mt-auto">
                <button id="add-trade-btn" class="w-full bg-sky-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-sky-700 transition-colors disabled:bg-slate-400 disabled:cursor-not-allowed" disabled>+ Añadir Operación</button>
                <button id="logout-btn" class="w-full mt-2 bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 transition-colors">Cerrar Sesión</button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto p-4 md:p-8">
            
            <div class="mb-6 flex justify-center">
                <div class="inline-flex rounded-md shadow-sm" role="group">
                    <button type="button" data-filter="monthly" class="filter-btn active px-4 py-2 text-sm font-medium text-gray-900 bg-white border border-gray-200 rounded-l-lg hover:bg-gray-100 hover:text-blue-700 focus:z-10 focus:ring-2 focus:ring-blue-700 focus:text-blue-700">
                        Este Mes
                    </button>
                    <button type="button" data-filter="historical" class="filter-btn px-4 py-2 text-sm font-medium text-gray-900 bg-white border-t border-b border-r border-gray-200 rounded-r-md hover:bg-gray-100 hover:text-blue-700 focus:z-10 focus:ring-2 focus:ring-blue-700 focus:text-blue-700">
                        Histórico
                    </button>
                </div>
            </div>

            <!-- Dashboard View -->
            <div id="view-dashboard">
                <header class="mb-8">
                    <h2 class="text-3xl font-bold text-slate-900">Dashboard de Guerra</h2>
                    <p class="text-slate-500 mt-1">Tus métricas de rendimiento en tiempo real. Analiza, aprende y conquista.</p>
                </header>

                <section class="bg-white p-6 rounded-xl border border-slate-200 mb-8">
                    <div class="flex justify-between items-center">
                        <h3 class="font-bold text-lg text-slate-900">Estado del Desafío de Fondeo</h3>
                        <div id="challenge-status-badge" class="px-3 py-1 text-sm font-bold rounded-full"></div>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-6 mt-4 text-center">
                        <div><p class="text-sm text-slate-500">Balance Inicial</p><p id="status-initial-balance" class="font-bold text-lg text-slate-800">$0.00</p></div>
                        <div><p class="text-sm text-slate-500">Balance Actual</p><p id="kpi-current-balance" class="font-bold text-lg text-sky-600">$0.00</p></div>
                        <div><p class="text-sm text-slate-500">Pérdida Total Máx. (10%)</p><p id="status-max-loss-limit" class="font-bold text-lg text-red-600">$0.00</p></div>
                        <div><p class="text-sm text-slate-500">Drawdown Actual</p><p id="status-current-drawdown" class="font-bold text-lg text-slate-800">$0.00</p></div>
                    </div>
                </section>

                <section class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-xl border border-slate-200"><h3 class="text-slate-500 font-medium">Profit Factor</h3><p id="kpi-profit-factor" class="text-3xl font-bold text-slate-900 mt-2">0.00</p></div>
                    <div class="bg-white p-6 rounded-xl border border-slate-200"><h3 class="text-slate-500 font-medium">Win Rate</h3><p id="kpi-win-rate" class="text-3xl font-bold text-slate-900 mt-2">0%</p></div>
                    <div class="bg-white p-6 rounded-xl border border-slate-200"><h3 class="text-slate-500 font-medium">R:R Promedio Obtenido</h3><p id="kpi-avg-rr" class="text-3xl font-bold text-slate-900 mt-2">0.00R</p></div>
                    <div class="bg-white p-6 rounded-xl border border-slate-200"><h3 class="text-slate-500 font-medium">Expectativa</h3><p id="kpi-expectancy" class="text-3xl font-bold text-slate-900 mt-2">$0.00</p></div>
                </section>
                <section class="bg-white p-6 rounded-xl border border-slate-200">
                    <h3 class="font-bold text-lg text-slate-900 mb-4">Registro de Batalla</h3>
                    <div class="overflow-x-auto"><table class="w-full text-sm text-left text-slate-500"><thead class="text-xs text-slate-700 uppercase bg-slate-100"><tr><th scope="col" class="px-6 py-3">Fecha</th><th scope="col" class="px-6 py-3">Instrumento</th><th scope="col" class="px-6 py-3">Duración</th><th scope="col" class="px-6 py-3">Resultado ($)</th><th scope="col" class="px-6 py-3">Acciones</th></tr></thead><tbody id="trade-log-body"></tbody></table></div>
                </section>
            </div>

            <!-- Analysis View -->
            <div id="view-analysis" class="hidden">
                <header class="mb-8">
                    <h2 class="text-3xl font-bold text-slate-900">Análisis de Rendimiento</h2>
                    <p class="text-slate-500 mt-1">Desglosa tus resultados para encontrar tus fortalezas y debilidades.</p>
                </header>
                <section class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-xl border border-slate-200">
                        <h3 class="font-bold text-lg text-slate-900 mb-4">Rendimiento por Dirección</h3>
                        <div class="grid grid-cols-2 gap-4 text-center">
                            <div><p class="text-sm text-slate-500">Win Rate (Compras)</p><p id="analysis-buy-wr" class="text-2xl font-bold text-green-600 mt-1">0%</p></div>
                             <div><p class="text-sm text-slate-500">Win Rate (Ventas)</p><p id="analysis-sell-wr" class="text-2xl font-bold text-red-600 mt-1">0%</p></div>
                        </div>
                        <div class="chart-container mt-4"><canvas id="analysis-buysell-chart"></canvas></div>
                    </div>
                    <div class="bg-white p-6 rounded-xl border border-slate-200">
                        <h3 class="font-bold text-lg text-slate-900 mb-4">Rendimiento por Sesión (GMT-3)</h3>
                        <div class="chart-container mt-4"><canvas id="analysis-session-chart"></canvas></div>
                    </div>
                </section>
                 <section class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-xl border border-slate-200">
                        <h3 class="text-slate-500 font-medium">Promedio TP (Pips)</h3>
                        <p id="kpi-avg-tp" class="text-3xl font-bold text-green-600 mt-2">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl border border-slate-200">
                        <h3 class="text-slate-500 font-medium">Promedio SL (Pips)</h3>
                        <p id="kpi-avg-sl" class="text-3xl font-bold text-red-600 mt-2">0</p>
                    </div>
                </section>
                <section class="bg-white p-6 rounded-xl border border-slate-200">
                    <h3 class="font-bold text-lg text-slate-900 mb-4">Rendimiento por Instrumento</h3>
                    <div class="chart-container mt-4"><canvas id="analysis-pair-chart"></canvas></div>
                </section>
            </div>

            <!-- Projection View (removed) -->

            <!-- Calendar View -->
            <div id="view-calendar" class="hidden">
                 <header class="mb-8"><h2 class="text-3xl font-bold text-slate-900">Calendario de Batalla</h2><p class="text-slate-500 mt-1">Tu rendimiento diario de un solo vistazo. Verde es victoria, rojo es lección.</p></header>
                <div class="bg-white p-6 rounded-xl border border-slate-200"><div class="flex items-center justify-between mb-4"><button id="prev-month-btn" class="p-2 rounded-full hover:bg-slate-100"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg></button><h3 id="calendar-month-year" class="text-xl font-bold text-slate-800"></h3><button id="next-month-btn" class="p-2 rounded-full hover:bg-slate-100"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg></button></div><div class="grid grid-cols-7 gap-px text-center text-sm font-semibold text-slate-500 border-b border-slate-200 mb-1"><div>Lun</div><div>Mar</div><div>Mié</div><div>Jue</div><div>Vie</div><div>Sáb</div><div>Dom</div></div><div id="calendar-grid" class="grid grid-cols-7 gap-px"></div></div>
            </div>

            <!-- Plan de Trading View -->
            <div id="view-plan" class="hidden">
                 <header class="mb-8"><h2 class="text-3xl font-bold text-slate-900">Plan de Trading y Desafío</h2><p class="text-slate-500 mt-1">Tus leyes y la configuración de tu prueba de fondeo.</p></header>
                <div class="space-y-8">
                    <div class="bg-white p-6 rounded-xl border border-slate-200"><h3 class="text-xl font-bold text-slate-900 mb-4">Configuración del Desafío</h3>
                        <div>
                            <label for="initial-balance" class="block text-sm font-medium text-slate-700">Balance Inicial del Desafío ($)</label>
                            <input type="number" id="initial-balance" value="100000" class="mt-1 block w-full md:w-1/2 rounded-md border-slate-300 shadow-sm focus:border-sky-500 focus:ring-sky-500">
                            <p class="mt-1 text-xs text-slate-500">Puedes editar este valor para ajustar tu simulación.</p>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-xl border border-slate-200"><h3 class="text-xl font-bold text-slate-900 mb-4">Sección 1: Mi Manifiesto</h3><div id="manifesto-content" class="space-y-3 text-slate-600"></div><button id="save-manifesto-btn" class="mt-4 bg-sky-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-sky-700 transition-colors">Guardar Manifiesto</button></div>
                    <div class="bg-white p-6 rounded-xl border border-slate-200"><h3 class="text-xl font-bold text-slate-900 mb-4">Sección 2: Parte de Guerra Diario</h3><div><textarea id="war-report" class="w-full mt-1 p-2 border border-slate-300 rounded-md h-48" placeholder="Pega aquí tu análisis de noticias de alto impacto para el día..."></textarea></div><button id="save-war-report-btn" class="mt-4 bg-sky-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-sky-700 transition-colors">Guardar Parte de Guerra</button></div>
                    <div class="bg-white p-6 rounded-xl border border-slate-200"><h3 class="text-xl font-bold text-slate-900 mb-4">Sección 3: Gestión de Riesgo y Capital (Reglas FTMO)</h3><ul class="list-disc list-inside space-y-3 text-slate-600"><li><strong>Riesgo Máximo por Operación:</strong> 0,5% de la cuenta.</li><li class="font-bold"><strong>Pérdida Máxima Diaria:</strong> 5% del balance inicial. Si se alcanza, se falla el desafío.</li><li class="font-bold"><strong>Pérdida Máxima Total (Drawdown):</strong> 10% del balance inicial. Si se alcanza, se falla el desafío.</li></ul></div>
                </div>
            </div>

            <!-- Revisión Semanal View -->
            <div id="view-review" class="hidden">
                <header class="mb-8"><h2 class="text-3xl font-bold text-slate-900">Revisión Semanal</h2><p class="text-slate-500 mt-1">Tu ritual de mejora. Enfréntate a tu mayor oponente: tú mismo.</p></header>
                <div class="bg-white p-6 rounded-xl border border-slate-200"><h3 class="text-xl font-bold text-slate-900 mb-4">Semana del <span id="review-date"></span></h3><div class="space-y-6"><div><label class="font-bold text-slate-700">1. Resultados de la Semana</label><textarea id="review-results" class="w-full mt-2 p-2 border border-slate-300 rounded-md h-24" placeholder="Resultado Neto ($ y R), Win Rate, Número de Operaciones..."></textarea></div><div><label class="font-bold text-slate-700">2. Análisis de Ejecución</label><textarea id="review-execution" class="w-full mt-2 p-2 border border-slate-300 rounded-md h-32" placeholder="Mi Mejor Operación (por ejecución): ¿Por qué?&#10;Mi Peor Operación: ¿Qué lección enseñó el mercado, incluso si seguí el plan?"></textarea></div><div><label class="font-bold text-slate-700">3. Reflexión Estoica</label><textarea id="review-reflection" class="w-full mt-2 p-2 border border-slate-300 rounded-md h-32" placeholder="¿Qué patrón (mental o de mercado) se repitió?&#10;¿Qué factor externo (cansancio, estrés) afectó mi trading?&#10;¿Qué está bajo mi control que puedo mejorar?"></textarea></div><div><label class="font-bold text-slate-700">4. Plan de Acción para la Próxima Semana</label><textarea id="review-action-plan" class="w-full mt-2 p-2 border border-slate-300 rounded-md h-24" placeholder="Un ÚNICO Objetivo de Mejora (Ej: No operar después de 2 pérdidas seguidas)."></textarea></div><button id="save-review-btn" class="bg-sky-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-sky-700 transition-colors">Guardar Revisión</button></div></div>
            </div>
            
            <!-- Archive View -->
            <div id="view-archive" class="hidden">
                <header class="mb-8"><h2 class="text-3xl font-bold text-slate-900">Archivo de Revisiones</h2><p class="text-slate-500 mt-1">Las lecciones aprendidas en batallas pasadas.</p></header>
                <div id="archive-container" class="space-y-6"></div>
            </div>
        </main>
    </div>

    <!-- Add/Edit Trade Modal -->
    <div id="trade-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl p-8 w-full max-w-lg max-h-full overflow-y-auto"><h2 id="modal-title" class="text-2xl font-bold text-slate-900 mb-6">Añadir Nueva Operación</h2><form id="trade-form" class="space-y-4">
            <input type="hidden" id="trade-id">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div><label for="trade-date" class="block text-sm font-medium text-slate-700">Fecha</label><input type="date" id="trade-date" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-sky-500 focus:ring-sky-500" required></div>
                <div><label for="trade-start-time" class="block text-sm font-medium text-slate-700">Hora Inicio (GMT-3)</label><input type="time" id="trade-start-time" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-sky-500 focus:ring-sky-500" required></div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div><label for="trade-end-time" class="block text-sm font-medium text-slate-700">Hora Fin (GMT-3)</label><input type="time" id="trade-end-time" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-sky-500 focus:ring-sky-500" required></div>
                <div><label for="trade-duration" class="block text-sm font-medium text-slate-700">Duración</label><input type="text" id="trade-duration" class="mt-1 block w-full rounded-md border-slate-300 bg-slate-100 shadow-sm" readonly></div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                 <div>
                    <label for="trade-pair" class="block text-sm font-medium text-slate-700">Par / Instrumento</label>
                    <input type="text" id="trade-pair" list="pair-list" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-sky-500 focus:ring-sky-500" required>
                    <datalist id="pair-list"></datalist>
                </div>
                <div><label for="trade-direction" class="block text-sm font-medium text-slate-700">Dirección</label><select id="trade-direction" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-sky-500 focus:ring-sky-500"><option value="Largo">Largo</option><option value="Corto">Corto</option></select></div>
            </div>
            <div class="grid grid-cols-1">
                <div><label for="trade-setup" class="block text-sm font-medium text-slate-700">Setup</label><input type="text" id="trade-setup" placeholder="Ej: Ruptura M15 + Retesteo OB" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-sky-500 focus:ring-sky-500" required></div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div><label for="trade-risk" class="block text-sm font-medium text-slate-700">Riesgo ($)</label><input type="number" step="0.01" id="trade-risk" placeholder="500" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-sky-500 focus:ring-sky-500" required></div>
                <div><label for="trade-result" class="block text-sm font-medium text-slate-700">Resultado ($)</label><input type="number" step="0.01" id="trade-result" placeholder="1500" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-sky-500 focus:ring-sky-500" required></div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                 <div><label for="trade-sl-pips" class="block text-sm font-medium text-slate-700">SL (Pips)</label><input type="number" step="0.1" id="trade-sl-pips" placeholder="10" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-sky-500 focus:ring-sky-500" required></div>
                 <div><label for="trade-tp-pips" class="block text-sm font-medium text-slate-700">TP (Pips)</label><input type="number" step="0.1" id="trade-tp-pips" placeholder="30" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-sky-500 focus:ring-sky-500" required></div>
            </div>
             <div class="grid grid-cols-1">
                 <div><label for="trade-discipline" class="block text-sm font-medium text-slate-700">Puntuación de Disciplina (1-5)</label><input type="number" id="trade-discipline" min="1" max="5" placeholder="5" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-sky-500 focus:ring-sky-500" required></div>
            </div>
            <div><label for="trade-screenshot" class="block text-sm font-medium text-slate-700">URL de la Captura (Opcional)</label><input type="url" id="trade-screenshot" placeholder="https://i.imgur.com/..." class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-sky-500 focus:ring-sky-500"><p class="mt-1 text-xs text-slate-500">Sube tu imagen a un servicio como Imgur y pega el enlace directo aquí.</p></div>
            <div class="flex justify-end space-x-4 pt-4"><button type="button" id="cancel-trade-btn" class="bg-slate-200 text-slate-800 font-bold py-2 px-4 rounded-lg hover:bg-slate-300 transition-colors">Cancelar</button><button type="submit" class="bg-sky-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-sky-700 transition-colors">Guardar Operación</button></div>
        </form></div>
    </div>
    
    <!-- Generic Modal for confirmations and viewing setup -->
    <div id="generic-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl p-8 w-full max-w-md">
            <h2 id="generic-modal-title" class="text-xl font-bold text-slate-900 mb-4"></h2>
            <p id="generic-modal-content" class="text-slate-600 mb-6 whitespace-pre-wrap"></p>
            <div id="generic-modal-actions" class="flex justify-end space-x-4">
                <!-- Buttons will be injected here -->
            </div>
        </div>
    </div>


<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, doc, setDoc, getDoc, query, orderBy, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDwbpN2FWpSrk91QXjKE0483qIfcL4T-fk",
      authDomain: "diario-de-tradig.firebaseapp.com",
      projectId: "diario-de-tradig",
      storageBucket: "diario-de-tradig.appspot.com",
      messagingSenderId: "190986085980",
      appId: "1:190986085980:web:ac00b98e9e3f5da3bc2899",
      measurementId: "G-7SD6M9NYBZ"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let allTrades = [];
    let filteredTrades = [];
    let allReviews = [];
    let initialBalance = 100000;
    let currentDate = new Date();
    let currentUser = null;
    let unsubscribeTrades = null; 
    let unsubscribeReviews = null;
    let currentFilter = 'monthly';

    let charts = {};

    const views = { dashboard: document.getElementById('view-dashboard'), analysis: document.getElementById('view-analysis'), projection: document.getElementById('view-projection'), calendar: document.getElementById('view-calendar'), plan: document.getElementById('view-plan'), review: document.getElementById('view-review'), archive: document.getElementById('view-archive') };
    const navLinks = { dashboard: document.getElementById('nav-dashboard'), analysis: document.getElementById('nav-analysis'), projection: document.getElementById('nav-projection'), calendar: document.getElementById('nav-calendar'), plan: document.getElementById('nav-plan'), review: document.getElementById('nav-review'), archive: document.getElementById('nav-archive') };
    const tradeModal = document.getElementById('trade-modal');
    const addTradeBtn = document.getElementById('add-trade-btn');
    const logoutBtn = document.getElementById('logout-btn');
    const tradeForm = document.getElementById('trade-form');
    const tradeLogBody = document.getElementById('trade-log-body');
    const initialBalanceInput = document.getElementById('initial-balance');
    const authOverlay = document.getElementById('auth-overlay');
    const appContainer = document.getElementById('app-container');
    const loginBtn = document.getElementById('login-btn');
    const registerBtn = document.getElementById('register-btn');
    const authError = document.getElementById('auth-error');
    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');
    const manifestoContent = document.getElementById('manifesto-content');
    const saveManifestoBtn = document.getElementById('save-manifesto-btn');
    const projectionSlider = document.getElementById('projection-slider');
    const projectionTradesLabel = document.getElementById('projection-trades-label');
    const calendarGrid = document.getElementById('calendar-grid');
    const calendarMonthYear = document.getElementById('calendar-month-year');
    const prevMonthBtn = document.getElementById('prev-month-btn');
    const nextMonthBtn = document.getElementById('next-month-btn');
    const tradeRiskInput = document.getElementById('trade-risk');
    const tradeResultInput = document.getElementById('trade-result');
    const pairList = document.getElementById('pair-list');
    const genericModal = document.getElementById('generic-modal');
    const genericModalTitle = document.getElementById('generic-modal-title');
    const genericModalContent = document.getElementById('generic-modal-content');
    const genericModalActions = document.getElementById('generic-modal-actions');
    const tradeStartTimeInput = document.getElementById('trade-start-time');
    const tradeEndTimeInput = document.getElementById('trade-end-time');
    const tradeDurationInput = document.getElementById('trade-duration');
    const saveReviewBtn = document.getElementById('save-review-btn');
    const archiveContainer = document.getElementById('archive-container');
    const warReportInput = document.getElementById('war-report');
    const saveWarReportBtn = document.getElementById('save-war-report-btn');
    
    function switchView(viewName) {
        Object.values(views).forEach(v => v.classList.add('hidden'));
        Object.values(navLinks).forEach(l => l.classList.remove('active'));
        if(views[viewName]) {
            views[viewName].classList.remove('hidden');
            navLinks[viewName].classList.add('active');
        }
        updateAll();
    }

    Object.keys(navLinks).forEach(key => {
        navLinks[key].addEventListener('click', () => switchView(key));
    });

    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            e.target.classList.add('active');
            currentFilter = e.target.dataset.filter;
            updateAll();
        });
    });

    function openTradeModal(trade = null) {
        // ... (modal opening logic)
    }

    addTradeBtn.addEventListener('click', () => openTradeModal());
    
    function calculateKPIs(tradesToAnalyze) {
        // ... (KPI calculation logic, now accepts tradesToAnalyze)
    }

    function updateUI() {
        const now = new Date();
        if (currentFilter === 'monthly') {
            filteredTrades = allTrades.filter(t => {
                const tradeDate = new Date(t.date + 'T' + (t.startTime || '00:00:00'));
                return tradeDate.getMonth() === now.getMonth() && tradeDate.getFullYear() === now.getFullYear();
            });
        } else {
            filteredTrades = allTrades;
        }

        const kpis = calculateKPIs(filteredTrades);
        // ... (update all KPI elements on the page)

        renderTradeLog(filteredTrades);
        
        if (!views.dashboard.classList.contains('hidden')) renderDashboardCharts(filteredTrades);
        if (!views.analysis.classList.contains('hidden')) renderAnalysisCharts(filteredTrades);
        if (views.projection && !views.projection.classList.contains('hidden')) renderProjectionChart();
        if (!views.calendar.classList.contains('hidden')) renderCalendar();
        if (views.archive && !views.archive.classList.contains('hidden')) renderArchive();
        
        updatePairDatalist();
    }
    
    function updatePairDatalist() {
        const defaultPairs = ["EUR/USD", "GBP/USD", "USD/JPY", "USD/CHF", "AUD/USD", "NZD/USD", "USD/CAD", "XAU/USD", "US30", "NAS100"];
        const tradedPairs = allTrades.map(t => t.pair.toUpperCase());
        const allPairs = [...new Set([...defaultPairs, ...tradedPairs])];
        pairList.innerHTML = allPairs.map(p => `<option value="${p}">`).join('');
    }

    function renderTradeLog(tradesToRender) {
        // ... (trade log rendering logic)
    }
    
    // ... (deleteTrade, showGenericModal, closeModal functions)

    function renderDashboardCharts(tradesToAnalyze) {
        // ... (logic for equity curve and discipline charts)
    }

    function renderAnalysisCharts(tradesToAnalyze) {
        // ... (logic for analysis charts: direction, session, instrument)
    }
    
    function renderCalendar() {
        // ... (calendar rendering logic)
    }

    function renderProjectionChart() {
        if(!views.projection) return;
        const historicalKPIs = calculateKPIs(allTrades);
        if (!historicalKPIs || historicalKPIs.expectancy <= 0) return;

        const numTrades = parseInt(projectionSlider.value);
        projectionTradesLabel.textContent = numTrades;

        let projectedBalance = historicalKPIs.currentBalance;
        const projectionData = Array.from({length: numTrades}, () => projectedBalance += historicalKPIs.expectancy);

        createOrUpdateChart('projection-chart', 'line', {
            labels: Array.from({length: numTrades}, (_, i) => `Op ${i + 1}`),
            datasets: [{
                label: 'Proyección de Balance ($)',
                data: [historicalKPIs.currentBalance, ...projectionData],
                borderColor: '#0ea5e9',
                backgroundColor: 'rgba(14, 165, 233, 0.1)',
                fill: true,
                tension: 0.1
            }]
        }, { responsive: true, maintainAspectRatio: false });
    }

    if(projectionSlider) {
        projectionSlider.addEventListener('input', renderProjectionChart);
    }

    // ... (tradeForm submission logic)

    async function saveManifesto() {
        if (!currentUser) return;
        const manifestoData = {
            why: document.getElementById('manifesto-why').value,
            profile: document.getElementById('manifesto-profile').value,
            goals: document.getElementById('manifesto-goals').value,
        };
        const userDocRef = doc(db, 'users', currentUser.uid);
        await setDoc(userDocRef, { manifesto: manifestoData }, { merge: true });
    }

    saveManifestoBtn.addEventListener('click', saveManifesto);

    function setupRealtimeListener(userId) {
        if (unsubscribeTrades) unsubscribeTrades(); 
        if (unsubscribeReviews) unsubscribeReviews();
        
        const userDocRef = doc(db, 'users', userId);
        const tradesCollectionRef = collection(userDocRef, 'trades');
        const q = query(tradesCollectionRef);

        getDoc(userDocRef).then(docSnap => {
            if (docSnap.exists()) {
                const data = docSnap.data();
                initialBalance = data.initialBalance || 100000;
                const manifesto = data.manifesto || { why: '', profile: '', goals: '' };
                manifestoContent.innerHTML = `
                    <p><strong>Mi Porqué:</strong></p>
                    <textarea id="manifesto-why" class="w-full mt-1 p-2 border border-slate-300 rounded-md">${manifesto.why}</textarea>
                    <p class="mt-4"><strong>Mi Perfil de Trader:</strong></p>
                    <textarea id="manifesto-profile" class="w-full mt-1 p-2 border border-slate-300 rounded-md">${manifesto.profile}</textarea>
                    <p class="mt-4"><strong>Mis Metas:</strong></p>
                    <textarea id="manifesto-goals" class="w-full mt-1 p-2 border border-slate-300 rounded-md">${manifesto.goals}</textarea>
                `;
            } else {
                setDoc(userDocRef, { initialBalance: 100000, manifesto: { why: '', profile: '', goals: '' } });
            }
            initialBalanceInput.value = initialBalance;

            unsubscribeTrades = onSnapshot(q, (snapshot) => {
                allTrades = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateAll();
            });
        });
    }

    loginBtn.addEventListener('click', () => {
        const email = emailInput.value;
        const password = passwordInput.value;
        authError.textContent = '';
        signInWithEmailAndPassword(auth, email, password)
            .catch(error => {
                authError.textContent = "Error: " + error.code;
            });
    });

    registerBtn.addEventListener('click', () => {
        const email = emailInput.value;
        const password = passwordInput.value;
        authError.textContent = '';
        createUserWithEmailAndPassword(auth, email, password)
            .catch(error => {
                authError.textContent = "Error: " + error.code;
            });
    });

    logoutBtn.addEventListener('click', () => {
        signOut(auth);
    });

    onAuthStateChanged(auth, (user) => {
        if (user) {
            currentUser = user;
            setupRealtimeListener(user.uid);
            authOverlay.style.display = 'none';
            appContainer.classList.remove('opacity-0');
            addTradeBtn.disabled = false;
        } else {
            currentUser = null;
            if(unsubscribeTrades) unsubscribeTrades();
            if(unsubscribeReviews) unsubscribeReviews();
            allTrades = [];
            allReviews = [];
            updateAll();
            authOverlay.style.display = 'flex';
            appContainer.classList.add('opacity-0');
            addTradeBtn.disabled = true;
        }
    });

    function updateAll() {
        updateUI();
    }
    
    const todayForReview = new Date();
    const weekStart = new Date(todayForReview.setDate(todayForReview.getDate() - todayForReview.getDay() + 1));
    const weekEnd = new Date(todayForReview.setDate(todayForReview.getDate() - todayForReview.getDay() + 7));
    const reviewDateEl = document.getElementById('review-date');
    if (reviewDateEl) {
        reviewDateEl.textContent = `${weekStart.toLocaleDateString()} al ${weekEnd.toLocaleDateString()}`;
    }
    
</script>

</body>
</html>